{"version":3,"sources":["server.ts"],"names":[],"mappings":"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","file":"server.js","sourcesContent":["\"use strict\";\n// import * as io from 'socket.io'\n// import * as _ from 'underscore'\n// import assert from 'assert'\n// import { AsyncMachine } from 'asyncmachine'\n\n\nconst io = require('socket.io')\nconst _ = require('underscore')\nconst assert = require('assert')\n\nconst server = io()\n\nserver.on('connection', () => {\n    console.log('new connection')\n})\n\n// class LoggerClient {\n//     io: SocketIO.Socket\n//     states: AsyncMachine\n    \n//     constructor(io) {\n//         this.io = io\n//         this.states = AsyncMachine.factory({\n//             Connecting: {\n//                 blocks: ['Connected']\n//             },\n//             Connected: {\n//                 blocks: ['Disconnected']\n//             },\n//             Disconnecting: {\n//                 blocks: ['Disconnected']\n//             },\n//             Disconnected: {\n//                 blocks: ['Disconnecting']\n//             }\n//         })\n//     }\n    \n//     Disconnect_state() {\n//         loggerSockets = _.without(loggerSockets, socket)\n//     }\n    \n//     Sync_Sync() {\n//         return this.Sync_state(...arguments)\n//     }\n    \n//     Sync_state() {\n//         var abort = this.states.getAbo\n//         this.io.emit('full-sync', diff)\n//         this.io.on('full-sync', this.)\n//     }\n    \n//     Diff_Sync() {\n//         return this.Sync_state(...arguments)\n//     }\n    \n//     Diff_state() {\n//         server.to(socket.loggerId).emit('diff-sync', diff)\n//     }\n// }\n\n// SERVER ENDPOINT\n\ntype loggerSocket = SocketIO.Socket\nvar loggerEndpoint = server.of('/logger')\nvar loggerSockets: loggerSocket[] = []\n\nloggerEndpoint.on('connection', function(socket: loggerSocket) {\n    // constructor\n    console.log('new logger connected')\n    loggerSockets.push(socket)\n    // handlers\n    socket.on('disconnect', function() {\n        loggerSockets = _.without(loggerSockets, socket)\n    })\n    socket.on('diff-sync', function(diff) {\n        console.log(socket.loggerId)\n        server.to(socket.loggerId).emit('diff-sync', diff)\n    })\n    // store the ID    \n    assert(socket.handshake.query, 'query param required')\n    let id = socket.handshake.query.id\n    assert(id, 'query.id param required')\n    socket.loggerId = id\n})\n\n// CLIENT ENDPOINT\n\ntype clientSocket = SocketIO.Socket\nvar clientEndpoint = server.of('/client')\nvar clientSockets: clientSocket[] = []\n\n// TODO gc\nvar clientsPerLogger = new Map<loggerSocket, clientSocket[]>()\n\nclientEndpoint.on('connection', function(socket: clientSocket) {\n    // constructor\n    console.log('new ui connected')\n    clientSockets.push(socket)\n    // handlers\n    socket.on('disconnect', function() {\n        clientSockets = _.without(clientSockets, socket)\n    })\n    \n    // join logic\n    socket.on('join', function(event: IJoinEvent) {\n        socket.join(event.loggerId)\n        // TODO find by ID\n        let loggerSocket = loggerSockets[0]\n        if (!clientsPerLogger.has(loggerSocket))\n            clientsPerLogger.set(loggerSocket, [])\n        clientsPerLogger.get(loggerSocket).push(socket)\n        // TODO group clients for this request\n        loggerSocket.emit('full-sync')\n        loggerSocket.once('full-sync', function(json) {\n            socket.emit('full-sync', json)\n        })\n    })\n    \n    // send the list of loggers\n    socket.emit('loggers', loggerSockets.map( socket => socket.loggerId ))\n})\n\n// TODO config\nserver.listen(3030)\n\ninterface IJoinEvent {\n    loggerId: string;\n}\n    "],"sourceRoot":"/source/"}